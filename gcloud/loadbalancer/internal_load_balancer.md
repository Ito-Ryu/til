# Google Cloud 内部ロードバランサ (Internal Load Balancing) 徹底解説

Google Cloud の内部ロードバランサは、VPC ネットワーク内のサービス間トラフィックを効率的に分散し、高可用性とスケーラビリティを実現します。用途に応じて、レイヤ 4 (L4) または レイヤ 7 (L7) の複数のタイプが提供されています。

参照元: [Google Cloud Load Balancing Documentation](https://docs.cloud.google.com/load-balancing/docs/internal)

---

## 1. ロードバランサの主要な分類 (L4 vs L7)

| 特徴 | L4 内部パススルー (Network) | L4 内部プロキシ (Network) | L7 内部アプリケーション (Application) |
| :--- | :--- | :--- | :--- |
| **タイプ** | パススルー型 (非プロキシ) | プロキシ型 (Envoy ベース) | プロキシ型 (Envoy ベース) |
| **プロトコル** | TCP, UDP, ICMP, GRE 等 | TCP, SSL | HTTP, HTTPS, HTTP/2, gRPC |
| **SSL 終端** | 不可 (バックエンドで処理) | 可能 (ロードバランサで処理) | 可能 (ロードバランサで処理) |
| **送信元 IP** | クライアント IP を保持 | プロキシの IP に変更される | プロキシの IP に変更される |
| **主な特徴** | 超低遅延、高スループット | SSL オフロード、L4 制御 | 高度な L7 ルーティング |

---

## 2. 各ロードバランサの詳細

### Internal Passthrough Network Load Balancer (L4)
*   **動作原理:** クライアントからのパケットを書き換えず、そのままバックエンドにルーティングします (Direct Server Return)。
*   **メリット:** プロキシを介さないため、極めて低い遅延と高いパフォーマンスを発揮します。
*   **グローバルアクセス:** 有効にすると、他リージョンのクライアントからもアクセス可能になります。

### Internal Proxy Network Load Balancer (L4)
*   **動作原理:** クライアントの接続をロードバランサ (Envoy) で終端し、バックエンドへ新しい接続を作成します。
*   **メリット:** バックエンドでの SSL 処理をオフロードでき、バックエンド構成を柔軟に変更可能です。
*   **利用条件:** 後述の「プロキシ専用サブネット」が必要です。

### Internal Application Load Balancer (L7)
*   **リージョン vs クロスリージョン:** 単一リージョン内の負荷分散に加え、複数リージョンにまたがるバックエンドをサポートするクロスリージョン構成も可能です。
*   **高度な機能:** URL パスベースのルーティング、リライト、ヘッダー修正、Google Cloud Armor との統合 (リージョン版) などが利用可能です。

---

## 3. プロキシ専用サブネット (Proxy-only subnets)

**内部プロキシ型ロードバランサ** (L4 Proxy および L7 Application) を使用する場合、各リージョンに「プロキシ専用サブネット」を作成する必要があります。

*   **役割:** ロードバランサがトラフィックを処理するために使用する Envoy プロキシ群の IP アドレスを確保する場所です。
*   **要件:**
    *   VPC ネットワークごとにリージョンあたり 1 つ必要。
    *   目的を `REGIONAL_MANAGED_PROXY` として作成する。
    *   バックエンドとの通信は、このサブネットの IP から行われるため、ファイアウォールで許可する必要があります。

---

## 4. ヘルスチェック (Health Checks)

バックエンドの健全性を監視し、正常なインスタンスにのみトラフィックを送信します。ロードバランサのタイプによって、ヘルスチェックの送信元 IP アドレスが異なります。

### Internal Passthrough Network Load Balancer (L4)
*   **送信元 IP:** Google Cloud のヘルスチェックシステム (`35.191.0.0/16`, `130.211.0.0/22`) から送信されます。
*   **ファイアウォール設定:** バックエンド VM のファイアウォールルールで、上記 IP 範囲からの通信を許可する必要があります。

### Internal Proxy (L4) & Application (L7) Load Balancer
*   **送信元 IP:** **プロキシ専用サブネット (Proxy-only subnet)** 内の IP アドレスから送信されます。
*   **ファイアウォール設定:** バックエンド VM のファイアウォールルールで、**プロキシ専用サブネットの IP 範囲**からの通信を許可する必要があります。Google のグローバルヘルスチェック範囲 (`35.191...` 等) を許可するだけでは不十分です。

---

## まとめ: 選択のポイント
1.  **クライアント IP の保持が必要、または HTTP 以外の特殊プロトコルを使いたい** → **内部パススルー**
2.  **L4 レベルで SSL 終端をまとめたい、ハイブリッド接続を使いたい** → **内部プロキシ**
3.  **URL パスやホスト名に基づいた柔軟なルーティングをしたい** → **内部アプリケーション**